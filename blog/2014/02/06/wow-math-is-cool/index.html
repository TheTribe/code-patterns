
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Wow, math is cool... as long as I don't have to code it - code-patterns</title>
  <meta name="author" content="John Batte">

  
  <meta name="description" content="TL;DR: MathNet.Numerics is really awesome! I just coded out a couple of new extension methods in response to an issue I created recently: EmptyIfNull &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://thetribe.github.io/code-patterns//blog/2014/02/06/wow-math-is-cool/">
  <link href="/code-patterns/favicon.png" rel="icon">
  <link href="/code-patterns/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/code-patterns/javascripts/modernizr-2.0.js"></script>
  <script src="/code-patterns/javascripts/ender.js"></script>
  <script src="/code-patterns/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/code-patterns/atom.xml" rel="alternate" title="code-patterns" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46816708-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
    <div id="logoLeft">{</div>
    <div id="logoText"><a href="/code-patterns/">code-patterns</a></div>
    <div id="logoRight">}</div>
    <div class="clear"></div>
  </div>
  
    <h2>Lots of reusable goodies for your .NET project.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/code-patterns/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:thetribe.github.io/code-patterns/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/code-patterns/">Home</a></li>
  <li><a href="/code-patterns/blog/">Blog</a></li>
  <li><a href="/code-patterns/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Wow, Math Is Cool... As Long as I Don't Have to Code It</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-02-06T12:49:41-06:00" pubdate data-updated="true">Feb 6<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>TL;DR</strong>: <a href="https://github.com/mathnet/mathnet-numerics">MathNet.Numerics</a> is really awesome!</p>

<p>I just coded out a couple of new extension methods in response to <a href="https://github.com/TheTribe/code-patterns/issues/152">an issue</a> I created recently: <code>EmptyIfNull</code> and <code>Compact</code>. Both of them operate on enumerable sets of items. <code>EmptyIfNull</code> converts a null set into an empty one, preventing repetitive or lengthy null checks in LINQ queries. <code>Compact</code> attaches a new <code>Where</code> clause to the set, filtering out null items. The net effect is that you&rsquo;ll be able to run queries against sets of objects while maintaining null safety, without sacrificing the gracefulness of the call flow. Here&rsquo;s an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">extractor</span> <span class="p">=</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="k">set</span>
</span><span class='line'>  <span class="p">.</span><span class="n">EmptyIfNull</span><span class="p">().</span><span class="n">Compact</span><span class="p">().</span><span class="n">Select</span><span class="p">(</span><span class="n">item</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span> <span class="c1">// too easy!</span>
</span><span class='line'>
</span><span class='line'><span class="kt">string</span><span class="p">[]</span> <span class="n">set1</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]{</span> <span class="s">&quot;thing0&quot;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s">&quot;thing25&quot;</span><span class="p">,</span> <span class="k">null</span> <span class="p">};</span>
</span><span class='line'><span class="kt">string</span><span class="p">[]</span> <span class="n">set2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">lengths1</span> <span class="p">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">set1</span><span class="p">);</span> <span class="c1">// 6,7</span>
</span><span class='line'><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">lengths2</span> <span class="p">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">set2</span><span class="p">);</span> <span class="c1">// empty</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works, but every new thing we do in code-patterns is supposed to be done in a BDD workflow&hellip; I should know; it was my rule! There are a few considerations I had to make in order to be sure I was testing what I thought I was testing. As always, the testing logic is several orders of magnitude harder to grok than the logic under test, but hey whatever! This is fun stuff!</p>

<p>The first weird spot I hit was mathematical in nature, and the second was all about SpecFlow bindings. I&rsquo;ll write up a separate article about the SpecFlow bits, so that this article can just focus on what a math nerd I&rsquo;m not. The math-nerdy method is <code>Compact</code>. It&rsquo;s not obvious why at first (the implementation is one line of code!) but bear with me. I don&rsquo;t want the nulls in my set to show up in predictable locations within the set. If they are always at the beginning, middle, or end of the set, then an algorithm that simply trims the ends of the set, or eliminates nulls when they are in a sequence would generate a false positive. If I have an evenly distributed random sort of the items in that set, then the nulls will always be in unpredictable locations, and the algorithm will only be able to consistently pass by doing exactly what it&rsquo;s meant to: remove all nulls, regardless of location. This isn&rsquo;t about the fact that there&rsquo;s just a simple <code>Where</code> clause under the covers. It&rsquo;s about the fact that this new extension promises to do something to your data without leaking any details about how it did so to the consumer. That means the only valid way to test is by making zero assumptions. So&hellip; hopefully I haven&rsquo;t made myself sound too crazy here&hellip; anyway, on to the math in all this:</p>

<p>Let&rsquo;s say I have a set of 100 strings. I know that 5% (so, 5) of these strings need to have a null value. I can easily get 95 other randomly generated values as well, and each of them needs to have the same even-but-random distribution as each of the 5 nulls I need. The problem: I need to generate a random distribution of all 100 items. It won&rsquo;t do to have them show up in a sequence OR a regular pattern in the set. I knew there was a known algorithm that handles this, but Spaghetti Monster help me if I have to implement any of it myself. I&rsquo;d just punt the ball and go with <code>Random.Next</code>!</p>

<p>Luckily for me, <a href="https://github.com/mathnet/mathnet-numerics">MathNet.Numerics</a> exists. This set of libraries is amazingly cool, and gives the world access to math functions that I&rsquo;ll probably never completely understand&hellip; all the better that it&rsquo;s been done for me and is considered to be in a working state. After doing a little research, it turns out the distribution I needed was the first 100 distinct items from a <a href="http://en.wikipedia.org/wiki/Uniform_distribution_%28discrete%29">Discrete Uniform</a> distribution of a <a href="http://en.wikipedia.org/wiki/Mersenne_twister">Mersenne Twister</a> sequence. I chose the Mersenne Twister PRNG because of its wide level of acceptance as the superior algorithm. Let&rsquo;s start with the generation of positional values using this distribution. This is so easy it&rsquo;s scary:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MersenneTwister</span><span class="p">();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">positions</span> <span class="p">=</span> <span class="n">DiscreteUniform</span><span class="p">.</span><span class="n">Samples</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">count</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Distinct</span><span class="p">().</span><span class="n">Take</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I have a pseudo-random list of positional indexes that can be used to randomize the sequence of a set of items of known size. All I have to do to apply that set of indexes is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">sortedValues</span> <span class="p">=</span> <span class="n">positions</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">position</span> <span class="p">=&gt;</span> <span class="n">values</span><span class="p">[</span><span class="n">position</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>How great is that? Here&rsquo;s the full method signature that I ended up with in my test code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">CreateStringSet</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nullCount</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">nulls</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">nullCount</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">nonNulls</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="n">nullCount</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">_generator</span><span class="p">.</span><span class="n">Phrase</span><span class="p">(</span><span class="m">20</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">values</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">nulls</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">nonNulls</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">DiscreteUniform</span><span class="p">.</span><span class="n">Samples</span><span class="p">(</span><span class="k">new</span> <span class="n">MersenneTwister</span><span class="p">(),</span> <span class="m">0</span><span class="p">,</span> <span class="n">count</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Distinct</span><span class="p">().</span><span class="n">Take</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">position</span> <span class="p">=&gt;</span> <span class="n">values</span><span class="p">[</span><span class="n">position</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>BTW, the <code>_generator.Phrase</code> call is using <a href="https://github.com/garethdown44/nbuilder/">NBuilder</a>&rsquo;s <code>RandomGenerator</code> class&mdash;another cool little OSS tool you should know about.</p>

<p>So that&rsquo;s it. That was a really long explanation for using something that&rsquo;s exponentially more complex than I can explain to test something that&rsquo;s exponentially less complex than this blog post would seem to indicate&hellip; yeah. I love being a nerd.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">John Batte</span></span>

      








  


<time datetime="2014-02-06T12:49:41-06:00" pubdate data-updated="true">Feb 6<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://thetribe.github.io/code-patterns//blog/2014/02/06/wow-math-is-cool/" data-via="" data-counturl="http://thetribe.github.io/code-patterns//blog/2014/02/06/wow-math-is-cool/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/code-patterns/blog/2014/02/04/pre-release-builds-on-myget/" title="Previous Post: Pre-release builds on MyGet">&laquo; Pre-release builds on MyGet</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/code-patterns/blog/2014/02/06/wow-math-is-cool/">Wow, Math Is Cool... As Long as I Don't Have to Code It</a>
      </li>
    
      <li class="post">
        <a href="/code-patterns/blog/2014/02/04/pre-release-builds-on-myget/">Pre-release Builds on MyGet</a>
      </li>
    
      <li class="post">
        <a href="/code-patterns/blog/2014/01/17/hello-world/">Hello World</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - John Batte -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <hr/>
  <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">code-patterns blog content</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://thetribe.github.io/hbase-client/" property="cc:attributionName" rel="cc:attributionURL">John Batte</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<br /><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codemonkeytribe';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://thetribe.github.io/code-patterns//blog/2014/02/06/wow-math-is-cool/';
        var disqus_url = 'http://thetribe.github.io/code-patterns//blog/2014/02/06/wow-math-is-cool/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
