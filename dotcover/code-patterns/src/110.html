<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_110 = [
   [47,3,47,92,'dccv']
, [48,3,48,4,'dccv']
, [49,4,49,32,'dccv']
, [50,4,50,46,'dccv']
, [51,4,51,111,'dccv']
, [52,3,52,4,'dccv']
, [59,3,59,91,'dccv']
, [60,3,60,4,'dccv']
, [61,3,61,4,'dccv']
, [66,3,66,70,'dccv']
, [67,3,67,4,'dccv']
, [68,3,68,4,'dccv']
, [76,45,76,46,'dccv']
, [76,47,76,71,'dccv']
, [76,72,76,73,'dccv']
, [94,3,94,4,'dccv']
, [95,7,95,47,'dccv']
, [96,3,96,4,'dccv']
, [109,3,109,4,'dccv']
, [110,4,110,59,'dccv']
, [111,4,111,52,'dccv']
, [112,4,112,29,'dccv']
, [112,30,112,55,'dccv']
, [114,4,114,88,'dccv']
, [115,4,115,24,'dccv']
, [116,4,116,16,'dccv']
, [117,3,117,4,'dccv']
, [128,3,128,4,'dccv']
, [129,4,129,41,'dccv']
, [130,3,130,4,'dccv']
, [140,3,140,4,'dccv']
, [141,4,141,40,'dccv']
, [142,4,142,30,'dccv']
, [143,3,143,4,'dccv']
, [154,3,154,4,'dccv']
, [155,4,155,33,'dccv']
, [156,74,156,76,'dccv']
, [158,4,158,16,'dccv']
, [159,3,159,4,'dccv']
, [170,3,170,4,'dccv']
, [171,4,171,33,'dccv']
, [172,74,172,76,'dccv']
, [174,4,174,16,'dccv']
, [175,3,175,4,'dccv']
, [220,3,220,4,'dccv']
, [221,4,221,41,'dccv']
, [222,4,222,26,'dccv']
, [223,4,223,30,'dccv']
, [224,3,224,4,'dccv']
, [155,33,156,74,'dccv']
, [171,33,172,74,'dccv']
, [186,3,186,4,'dcuc']
, [187,4,187,33,'dcuc']
, [187,70,188,76,'dcuc']
, [190,4,190,16,'dcuc']
, [191,3,191,4,'dcuc']
, [201,3,201,4,'dcuc']
, [202,4,202,33,'dcuc']
, [202,63,202,65,'dcuc']
, [203,4,203,16,'dcuc']
, [204,3,204,4,'dcuc']
, [214,3,214,4,'dcuc']
, [215,4,215,36,'dcuc']
, [216,4,216,16,'dcuc']
, [217,3,217,4,'dcuc']
, [187,33,187,55,'dcuc']
, [187,70,188,74,'dcuc']
, [187,55,187,70,'dcuc']
, [202,33,202,63,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src110" class="dotCoverSource"><pre>#region FreeBSD

// Copyright (c) 2013, John Batte
// All rights reserved.
// 
// Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
// 
//  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
// 
//  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the
//    documentation and/or other materials provided with the distribution.
// 
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
// TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
// LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

#endregion

using System;
using System.Collections.Generic;
using Autofac;
using Autofac.Core;
using Autofac.Extras.CommonServiceLocator;
using Microsoft.Practices.ServiceLocation;
using Moq;
using Patterns.Autofac;
using Patterns.ExceptionHandling;
using Patterns.Testing.Moq;

namespace Patterns.Testing.Autofac.Moq
{
	/// &lt;summary&gt;
	///	 Provides a default implementation of the &lt;see cref=&quot;IAutofacMoqContainer&quot; /&gt; interface.
	/// &lt;/summary&gt;
	public sealed class AutofacMoqContainer : AccessibleContainer, IAutofacMoqContainer
	{
		private readonly MockBehavior _defaultBehavior;
		private readonly MoqRegistrationSource _registrationSource;

		/// &lt;summary&gt;
		///	 Initializes a new instance of the &lt;see cref=&quot;AutofacMoqContainer&quot; /&gt; class with 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;defaultBehavior&quot;&gt;The default &lt;see cref=&quot;MockBehavior&quot;/&gt;.&lt;/param&gt;
		public AutofacMoqContainer(IContainer container, MockBehavior behavior) : base(container)
		{
			_defaultBehavior = behavior;
			Locator = new AutofacServiceLocator(this);
			ComponentRegistry.AddRegistrationSource(_registrationSource = new MoqRegistrationSource(_defaultBehavior));
		}

		/// &lt;summary&gt;
		///	 Initializes a new instance of the &lt;see cref=&quot;AutofacMoqContainer&quot; /&gt; class.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;container&quot;&gt;The container.&lt;/param&gt;
		/// &lt;param name=&quot;defaultBehavior&quot;&gt;The default &lt;see cref=&quot;MockBehavior&quot;/&gt;.&lt;/param&gt;
		public AutofacMoqContainer(IContainer container) : this(container, MockBehavior.Default)
		{
		}

		/// &lt;summary&gt;
		///	 Initializes a new instance of the &lt;see cref=&quot;AutofacMoqContainer&quot; /&gt; class.
		/// &lt;/summary&gt;
		public AutofacMoqContainer() : this(new ContainerBuilder().Build())
		{
		}

		/// &lt;summary&gt;
		///	 Gets the default &lt;see cref=&quot;MockBehavior&quot;/&gt;.
		/// &lt;/summary&gt;
		/// &lt;value&gt;
		///	 The default &lt;see cref=&quot;MockBehavior&quot;/&gt;.
		/// &lt;/value&gt;
		public MockBehavior DefaultBehavior { get { return _defaultBehavior; } }

		/// &lt;summary&gt;
		///	 Gets the locator.
		/// &lt;/summary&gt;
		/// &lt;value&gt;
		///	 The locator.
		/// &lt;/value&gt;
		public IServiceLocator Locator { get; private set; }

		/// &lt;summary&gt;
		///	 Retrieves the mock for the specified service type.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;returns&gt;
		///	 The service mock.
		/// &lt;/returns&gt;
		public Mock&lt;TService&gt; Mock&lt;TService&gt;() where TService : class
		{
		    return Mock&lt;TService&gt;(_defaultBehavior);
		}

		/// &lt;summary&gt;
		///	 Retrieves the mock for the specified service type.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;param name=&quot;mockBehavior&quot;&gt;
		///	 The &lt;see cref=&quot;MockBehavior&quot; /&gt; of the mock.
		/// &lt;/param&gt;
		/// &lt;returns&gt;
		///	 The service mock.
		/// &lt;/returns&gt;
		public Mock&lt;TService&gt; Mock&lt;TService&gt;(MockBehavior mockBehavior) where TService : class
		{
			TService service = Try.Get&lt;TService&gt;(Create&lt;TService&gt;);
			var existingMock = service as IMocked&lt;TService&gt;;
			if (existingMock != null) return existingMock.Mock;

			Mock&lt;TService&gt; mock = _registrationSource.Repository.Create&lt;TService&gt;(mockBehavior);
			Update(mock.Object);
			return mock;
		}

		/// &lt;summary&gt;
		///	 Creates an instance of the specified service, injecting mocked objects
		///	 for all unregistered dependencies.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;returns&gt;
		///	 The service instance.
		/// &lt;/returns&gt;
		public TService Create&lt;TService&gt;() where TService : class
		{
			return Container.Resolve&lt;TService&gt;();
		}

		/// &lt;summary&gt;
		///	 Creates an instance of the specified implementation (as the specified service),
		///	 injecting mocked objects for all unregistered dependencies.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;typeparam name=&quot;TImplementation&quot;&gt;The type of the implementation.&lt;/typeparam&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public TService Create&lt;TService, TImplementation&gt;() where TService : class where TImplementation : TService
		{
			Update&lt;TService, TImplementation&gt;();
			return Create&lt;TService&gt;();
		}

		/// &lt;summary&gt;
		///	 Updates this instance by registering the implementation type as the service type.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;typeparam name=&quot;TImplementation&quot;&gt;The type of the implementation.&lt;/typeparam&gt;
		/// &lt;returns&gt;
		///	 The container.
		/// &lt;/returns&gt;
		public IMoqContainer Update&lt;TService, TImplementation&gt;() where TService : class where TImplementation : TService
		{
			UpdateWithBuilder(builder =&gt; builder.RegisterType&lt;TImplementation&gt;().As&lt;TService&gt;()
												.PropertiesAutowired(PropertyWiringOptions.PreserveSetValues));

			return this;
		}

		/// &lt;summary&gt;
		///	 Updates this instance by registering an instance of the specified service.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;param name=&quot;instance&quot;&gt;The instance.&lt;/param&gt;
		/// &lt;returns&gt;
		///	 The container.
		/// &lt;/returns&gt;
		public IMoqContainer Update&lt;TService&gt;(TService instance) where TService : class
		{
			UpdateWithBuilder(builder =&gt; builder.RegisterInstance(instance).As&lt;TService&gt;()
												.PropertiesAutowired(PropertyWiringOptions.PreserveSetValues));

			return this;
		}

		/// &lt;summary&gt;
		///	 Updates this instance by registering the specified activator as the service type.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TService&quot;&gt;The type of the service.&lt;/typeparam&gt;
		/// &lt;param name=&quot;activator&quot;&gt;The activator.&lt;/param&gt;
		/// &lt;returns&gt;
		///	 The container
		/// &lt;/returns&gt;
		public IMoqContainer Update&lt;TService&gt;(Func&lt;IMoqContainer, TService&gt; activator) where TService : class
		{
			UpdateWithBuilder(builder =&gt; builder.Register(c =&gt; activator(this)).As&lt;TService&gt;()
												.PropertiesAutowired(PropertyWiringOptions.PreserveSetValues));

			return this;
		}

		/// &lt;summary&gt;
		///	 Updates the container using the specified module.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;module&quot;&gt;The module.&lt;/param&gt;
		/// &lt;returns&gt;
		///	 The container.
		/// &lt;/returns&gt;
		public IAutofacMoqContainer Update(Module module)
		{
			UpdateWithBuilder(builder =&gt; builder.RegisterModule(module));
			return this;
		}

		/// &lt;summary&gt;
		///	 Updates the container using the specified registration.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;registration&quot;&gt;The registration.&lt;/param&gt;
		/// &lt;returns&gt;
		///	 The container.
		/// &lt;/returns&gt;
		public IAutofacMoqContainer Update(Action&lt;ContainerBuilder&gt; registration)
		{
			UpdateWithBuilder(registration);
			return this;
		}

		private void UpdateWithBuilder(Action&lt;ContainerBuilder&gt; registration)
		{
			var builder = new ContainerBuilder();
			registration(builder);
			builder.Update(Container);
		}
	}
}</pre></code><script type="text/javascript">
			applyranges('src110', RANGES_110)
		</script>
	</body>
</html>